<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Dashboard - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #4CAF50;
            border: none;
            cursor: pointer;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .stat-card.active {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
        }

        .stat-card.active .stat-number {
            color: white;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            transition: color 0.3s ease;
        }

        .stat-label {
            margin-top: 5px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .emails-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .email-item {
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .email-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .email-item.high {
            border-left: 5px solid #f44336;
        }

        .email-item.medium {
            border-left: 5px solid #ff9800;
        }

        .email-item.low {
            border-left: 5px solid #4caf50;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .email-subject {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .urgency-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .urgency-badge.high {
            background: #f44336;
            color: white;
        }

        .urgency-badge.medium {
            background: #ff9800;
            color: white;
        }

        .urgency-badge.low {
            background: #4caf50;
            color: white;
        }

        .email-sender {
            color: #666;
            margin-bottom: 10px;
        }

        .email-summary {
            color: #444;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .email-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #888;
        }

        .meeting-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .email-detail {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .current-filter {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Dashboard</h1>
        </div>

        <div class="nav-bar">
            <a href="/" class="btn">‚Üê Back to Dashboard</a>
            <div>
                <button onclick="loadEmails()" class="btn btn-primary">üîÑ Refresh Emails</button>
                <button onclick="processMeetings()" class="btn btn-primary">‚ö° Process Meetings</button>
            </div>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card" onclick="filterEmailsByStats('all')" id="stat-all">
                <div class="stat-number" id="totalEmails">0</div>
                <div class="stat-label">Total Emails</div>
            </div>
            <div class="stat-card" onclick="filterEmailsByStats('high')" id="stat-high">
                <div class="stat-number" id="highPriority">0</div>
                <div class="stat-label">High Priority</div>
            </div>
            <div class="stat-card" onclick="filterEmailsByStats('action')" id="stat-action">
                <div class="stat-number" id="actionRequired">0</div>
                <div class="stat-label">Action Required</div>
            </div>
            <div class="stat-card" onclick="filterEmailsByStats('meeting')" id="stat-meeting">
                <div class="stat-number" id="meetingRequests">0</div>
                <div class="stat-label">Meetings</div>
            </div>
        </div>

        <div class="emails-container">
            <div id="currentFilter" class="current-filter" style="display: none;">
                Showing: All Emails
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterEmails('all')">All</button>
                <button class="filter-btn" onclick="filterEmails('high')">High Priority</button>
                <button class="filter-btn" onclick="filterEmails('medium')">Medium Priority</button>
                <button class="filter-btn" onclick="filterEmails('low')">Low Priority</button>
                <button class="filter-btn" onclick="filterEmails('meeting')">Meeting Requests</button>
                <button class="filter-btn" onclick="filterEmails('action')">Action Required</button>
            </div>

            <div id="emailsList">
                <div class="loading">
                    üìß Loading emails... Click "Refresh Emails" to load your latest emails.
                </div>
            </div>
        </div>
    </div>

    <script>
        let allEmails = [];
        let currentFilter = 'all';

        function loadEmails() {
            document.getElementById('emailsList').innerHTML = '<div class="loading">üîÑ Loading emails...</div>';
            
            fetch('/api/emails')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allEmails = data.emails;
                        updateStats(data);
                        displayEmails(allEmails);
                        updateCurrentFilterDisplay('all');
                    } else {
                        document.getElementById('emailsList').innerHTML = 
                            `<div class="loading">‚ùå Error: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('emailsList').innerHTML = 
                        '<div class="loading">‚ùå Failed to load emails</div>';
                });
        }

        function updateStats(data) {
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('totalEmails').textContent = data.total_count;
            
            const highPriority = data.emails.filter(e => e.ai_urgency === 'high').length;
            const actionRequired = data.emails.filter(e => e.action_required).length;
            
            document.getElementById('highPriority').textContent = highPriority;
            document.getElementById('actionRequired').textContent = actionRequired;
            document.getElementById('meetingRequests').textContent = data.meeting_count;
        }

        function displayEmails(emails) {
            const emailsList = document.getElementById('emailsList');
            
            if (emails.length === 0) {
                emailsList.innerHTML = '<div class="loading">üì™ No emails found for this filter</div>';
                return;
            }

            const emailsHTML = emails.map(email => `
                <div class="email-item ${email.ai_urgency}" onclick="toggleEmailDetail('${email.id}')">
                    <div class="email-header">
                        <div class="email-subject">${escapeHtml(email.subject)}</div>
                        <div>
                            <span class="urgency-badge ${email.ai_urgency}">${email.ai_urgency}</span>
                            ${email.is_meeting_request ? '<span class="meeting-indicator">üìÖ Meeting</span>' : ''}
                            ${email.action_required ? '<span class="meeting-indicator">‚ö° Action</span>' : ''}
                        </div>
                    </div>
                    <div class="email-sender">From: ${escapeHtml(email.sender)}</div>
                    <div class="email-summary">${escapeHtml(email.ai_summary)}</div>
                    <div class="email-meta">
                        <span>Category: ${email.ai_category}</span>
                        <span>Confidence: ${Math.round(email.confidence * 100)}%</span>
                        <span>${formatDate(email.date)}</span>
                    </div>
                    <div id="detail-${email.id}" class="email-detail">
                        <strong>AI Analysis:</strong><br>
                        ${escapeHtml(email.ai_reason)}<br><br>
                        <strong>Email Snippet:</strong><br>
                        ${escapeHtml(email.snippet)}
                    </div>
                </div>
            `).join('');

            emailsList.innerHTML = emailsHTML;
        }

        function filterEmailsByStats(type) {
            currentFilter = type;
            
            // Update stat card active states
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(`stat-${type}`).classList.add('active');
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the corresponding filter button
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                if ((type === 'all' && btn.textContent === 'All') ||
                    (type === 'high' && btn.textContent === 'High Priority') ||
                    (type === 'action' && btn.textContent === 'Action Required') ||
                    (type === 'meeting' && btn.textContent === 'Meeting Requests')) {
                    btn.classList.add('active');
                }
            });

            filterEmailsLogic(type);
        }

        function filterEmails(type) {
            currentFilter = type;
            
            // Update stat card active states
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Activate corresponding stat card
            if (type === 'all') document.getElementById('stat-all').classList.add('active');
            else if (type === 'high') document.getElementById('stat-high').classList.add('active');
            else if (type === 'action') document.getElementById('stat-action').classList.add('active');
            else if (type === 'meeting') document.getElementById('stat-meeting').classList.add('active');
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            filterEmailsLogic(type);
        }

        function filterEmailsLogic(type) {
            let filteredEmails = allEmails;
            let filterLabel = '';

            switch(type) {
                case 'high':
                    filteredEmails = allEmails.filter(e => e.ai_urgency === 'high');
                    filterLabel = 'High Priority Emails';
                    break;
                case 'medium':
                    filteredEmails = allEmails.filter(e => e.ai_urgency === 'medium');
                    filterLabel = 'Medium Priority Emails';
                    break;
                case 'low':
                    filteredEmails = allEmails.filter(e => e.ai_urgency === 'low');
                    filterLabel = 'Low Priority Emails';
                    break;
                case 'meeting':
                    filteredEmails = allEmails.filter(e => e.is_meeting_request);
                    filterLabel = 'Meeting Requests';
                    break;
                case 'action':
                    filteredEmails = allEmails.filter(e => e.action_required);
                    filterLabel = 'Action Required';
                    break;
                case 'all':
                default:
                    filteredEmails = allEmails;
                    filterLabel = 'All Emails';
                    break;
            }

            updateCurrentFilterDisplay(filterLabel);
            displayEmails(filteredEmails);
        }

        function updateCurrentFilterDisplay(filterText) {
            const currentFilterDiv = document.getElementById('currentFilter');
            currentFilterDiv.textContent = `Showing: ${filterText}`;
            currentFilterDiv.style.display = 'block';
        }

        function toggleEmailDetail(emailId) {
            const detail = document.getElementById(`detail-${emailId}`);
            if (detail.style.display === 'none' || detail.style.display === '') {
                detail.style.display = 'block';
            } else {
                detail.style.display = 'none';
            }
        }

        function processMeetings() {
            if (confirm('Process all meeting requests automatically?')) {
                fetch('/api/process_meeting_requests', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Processed ${data.processed_meetings.length} meeting requests!`);
                        loadEmails(); // Refresh the list
                    } else {
                        alert(`‚ùå Error: ${data.message || data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Failed to process meeting requests');
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return dateStr;
            }
        }
    </script>
</body>
</html>